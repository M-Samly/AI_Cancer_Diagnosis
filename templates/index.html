<!DOCTYPE html>
<html>
<head>
    <title>AI Cancer Diagnosis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .result-box {
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .bg-success { background-color: #d4edda; }
        .bg-danger { background-color: #f8d7da; }
        .bg-warning { background-color: #fff3cd; }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
        }
        .upload-area:hover {
            border-color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <h1 class="text-center mb-4">ðŸ©º AI Cancer Diagnosis</h1>
                <p class="text-center text-muted">Upload a histopathology image for AI-assisted diagnosis with uncertainty estimation</p>
                
                <div class="upload-area" id="uploadArea">
                    <h4>Upload Histopathology Image</h4>
                    <p class="text-muted">Supported formats: PNG, JPG, JPEG, TIF</p>
                    <form id="uploadForm" enctype="multipart/form-data">
                        <input type="file" id="fileInput" name="file" accept="image/*" class="form-control">
                        <button type="submit" class="btn btn-primary mt-3" id="predictBtn">Analyze Image</button>
                    </form>
                </div>

                <div id="result" style="display: none;">
                    <h3 class="text-center mb-4">Analysis Results</h3>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Uploaded Image:</h5>
                            <img id="previewImage" class="img-fluid rounded" style="max-height: 300px;">
                        </div>
                        <div class="col-md-6">
                            <div id="resultBox" class="result-box">
                                <h4 id="diagnosisText"></h4>
                                <div id="confidenceBar" class="progress mb-3" style="height: 25px;">
                                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <table class="table table-sm">
                                    <tr><td><strong>Confidence:</strong></td><td id="confidenceValue"></td></tr>
                                    <tr><td><strong>Uncertainty:</strong></td><td id="uncertaintyValue"></td></tr>
                                    <tr><td><strong>Normal Probability:</strong></td><td id="normalProb"></td></tr>
                                    <tr><td><strong>Cancer Probability:</strong></td><td id="cancerProb"></td></tr>
                                    <tr><td><strong>Decision:</strong></td><td id="decisionText"></td></tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="recommendation" class="alert alert-info">
                        <h5>Recommendation:</h5>
                        <p id="recommendationText"></p>
                    </div>
                </div>

                <div id="loading" class="text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Analyzing image with uncertainty estimation...</p>
                </div>

                <div id="error" class="alert alert-danger" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('Please select an image file');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            // Show loading, hide other sections
            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').style.display = 'none';
            document.getElementById('error').style.display = 'none';

            // Preview image
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImage').src = e.target.result;
            };
            reader.readAsDataURL(file);

            fetch('/predict', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                
                if (data.error) {
                    showError(data.error);
                    return;
                }

                displayResults(data);
            })
            .catch(error => {
                document.getElementById('loading').style.display = 'none';
                showError('Error: ' + error.message);
            });
        });

        function displayResults(data) {
            // Update result box
            const resultBox = document.getElementById('resultBox');
            resultBox.className = `result-box bg-${data.color}`;
            
            // Update values
            document.getElementById('diagnosisText').textContent = `Diagnosis: ${data.predicted_class}`;
            document.getElementById('confidenceValue').textContent = (data.confidence * 100).toFixed(2) + '%';
            document.getElementById('uncertaintyValue').textContent = (data.uncertainty * 100).toFixed(2) + '%';
            document.getElementById('normalProb').textContent = (data.normal_probability * 100).toFixed(2) + '%';
            document.getElementById('cancerProb').textContent = (data.cancer_probability * 100).toFixed(2) + '%';
            document.getElementById('decisionText').textContent = data.decision;
            
            // Update progress bar
            const confidenceBar = document.querySelector('.progress-bar');
            confidenceBar.style.width = (data.confidence * 100) + '%';
            confidenceBar.textContent = (data.confidence * 100).toFixed(1) + '%';
            
            // Set recommendation
            const recommendation = document.getElementById('recommendationText');
            if (data.rejected) {
                recommendation.textContent = 'High uncertainty detected. This case should be reviewed by a human expert. The AI system is not confident enough to make a reliable prediction.';
            } else if (data.predicted_class === 'Cancer') {
                recommendation.textContent = 'AI suggests potential cancer presence. Please consult with a medical specialist for further examination and confirmation.';
            } else {
                recommendation.textContent = 'AI suggests normal tissue. However, always consult with healthcare professionals for final diagnosis.';
            }
            
            // Show result
            document.getElementById('result').style.display = 'block';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
    </script>
</body>
</html>